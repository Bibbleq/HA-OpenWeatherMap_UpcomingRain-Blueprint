{# Full test for updated rain detection logic (v1.6.2) #}
{# This tests the new mm/h threshold system and smart compression #}

{% set Minute_Weather = [
  {'datetime': '2025-11-11T14:00:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:01:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:02:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:03:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:04:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:05:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:06:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:07:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:08:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:09:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:10:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:11:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:12:00+00:00', 'precipitation': 0.12},
  {'datetime': '2025-11-11T14:13:00+00:00', 'precipitation': 0.16},
  {'datetime': '2025-11-11T14:14:00+00:00', 'precipitation': 0.24},
  {'datetime': '2025-11-11T14:15:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:16:00+00:00', 'precipitation': 1.3},
  {'datetime': '2025-11-11T14:17:00+00:00', 'precipitation': 1.5},
  {'datetime': '2025-11-11T14:18:00+00:00', 'precipitation': 1.1},
  {'datetime': '2025-11-11T14:19:00+00:00', 'precipitation': 2.0},
  {'datetime': '2025-11-11T14:20:00+00:00', 'precipitation': 2.3},
  {'datetime': '2025-11-11T14:21:00+00:00', 'precipitation': 2.7},
  {'datetime': '2025-11-11T14:22:00+00:00', 'precipitation': 3.1},
  {'datetime': '2025-11-11T14:23:00+00:00', 'precipitation': 0.5},
  {'datetime': '2025-11-11T14:24:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:25:00+00:00', 'precipitation': 0},
  {'datetime': '2025-11-11T14:26:00+00:00', 'precipitation': 0},
] %}

{% set rain_threshold = 0.1 %} {# mm/h - new threshold #}
{% set gap_duration = 1 %} {# 1 minute gap tolerance #}

{# Extract precipitation values (these are already in mm/h from OpenWeatherMap) #}
{% set raw_precip = Minute_Weather | map(attribute='precipitation') | map('float') | list %}

{# Calculate values #}
{% set max_mm_per_hr = (raw_precip | max) | float(0) | round(1) %}
{% set total_mm_next_hour = (raw_precip | sum | float(0) / 60.0) | round(2) %}

{# Check for rain using raw mm/h values #}
{% set threshold = rain_threshold | float(0) %}
{% set rain_soon = (raw_precip | select('>', threshold) | list | length) > 0 %}

{# Find first minute with rain (index) #}
{% set ns = namespace(idx=None) %}
{% for i in range(raw_precip | length) %}
  {% if ns.idx is none and (raw_precip[i] | float(0)) > threshold %}
    {% set ns.idx = i %}
  {% endif %}
{% endfor %}
{% set minutes_until_rain = ns.idx %}

{# Expected rain duration - only count actual rain minutes, not dry gaps #}
{% set dur = namespace(rain_count=0, dry_count=0) %}
{% if minutes_until_rain is not none %}
  {% for i in range(minutes_until_rain, raw_precip | length) %}
    {% set p = (raw_precip[i] | float(0)) %}
    {% if p > threshold %}
      {% set dur.rain_count = dur.rain_count + 1 %}
      {% set dur.dry_count = 0 %}
    {% else %}
      {% set dur.dry_count = dur.dry_count + 1 %}
      {% if dur.dry_count > gap_duration %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}
{% set expected_rain_duration = dur.rain_count %}

{# Rain intensity #}
{% set r = max_mm_per_hr %}
{% if not rain_soon or r < 0.1 %}
  {% set rain_intensity = "None" %}
{% elif r < 2.5 %}
  {% set rain_intensity = "Light" %}
{% elif r < 10 %}
  {% set rain_intensity = "Moderate" %}
{% elif r < 50 %}
  {% set rain_intensity = "Heavy" %}
{% else %}
  {% set rain_intensity = "Violent" %}
{% endif %}

{# Smart compression for raw data storage #}
{% set ns_raw = namespace(out=[], zero_count=0, prev_lead='') %}
{% for v in raw_precip %}
  {% set val = v | float %}
  {% if val == 0 %}
    {% set ns_raw.zero_count = ns_raw.zero_count + 1 %}
  {% else %}
    {# Flush any accumulated zeros #}
    {% if ns_raw.zero_count > 0 %}
      {% if ns_raw.zero_count >= 3 %}
        {% set ns_raw.out = ns_raw.out + ['0*' ~ ns_raw.zero_count] %}
      {% else %}
        {% for _ in range(ns_raw.zero_count) %}
          {% set ns_raw.out = ns_raw.out + ['0'] %}
        {% endfor %}
      {% endif %}
      {% set ns_raw.zero_count = 0 %}
    {% endif %}
    {# Format non-zero value #}
    {% set s = ('%.2f' | format(val)) %}
    {% set lead = s.split('.')[0] %}
    {% if lead == ns_raw.prev_lead and lead != '0' %}
      {# Drop leading digit if same as previous #}
      {% set token = '.' ~ s.split('.')[1] %}
    {% elif s[:2] == '0.' %}
      {# Remove leading zero #}
      {% set token = s[1:] %}
      {% set ns_raw.prev_lead = '0' %}
    {% else %}
      {% set token = s %}
      {% set ns_raw.prev_lead = lead %}
    {% endif %}
    {% set ns_raw.out = ns_raw.out + [token] %}
  {% endif %}
{% endfor %}
{# Flush any remaining zeros #}
{% if ns_raw.zero_count > 0 %}
  {% if ns_raw.zero_count >= 3 %}
    {% set ns_raw.out = ns_raw.out + ['0*' ~ ns_raw.zero_count] %}
  {% else %}
    {% for _ in range(ns_raw.zero_count) %}
      {% set ns_raw.out = ns_raw.out + ['0'] %}
    {% endfor %}
  {% endif %}
{% endif %}
{% set raw_output = ns_raw.out | join(',') %}

{# ========== Validation Section ========== #}
{% set expected = {
  'rain_threshold': 0.1,
  'gap_duration': 1,
  'max_mm_per_hr': 3.1,
  'rain_soon': true,
  'minutes_until_rain': 12,
  'rain_intensity': 'Moderate',
  'expected_rain_duration': 11,
  'raw_output_length': true
} %}

{% set results = namespace(out=[]) %}

{# Helper macro to push messages #}
{% macro push(msg) -%}
  {%- set results.out = results.out + [msg] -%}
{%- endmacro %}

{# Validate threshold #}
{{ push('TEST: rain_threshold == ' ~ expected.rain_threshold ~ ' mm/h â†’ ' ~ ((threshold == expected.rain_threshold) and 'PASS' or 'FAIL')) }}
{{ push('TEST: gap_duration == ' ~ expected.gap_duration ~ ' minute(s) â†’ ' ~ ((gap_duration == expected.gap_duration) and 'PASS' or 'FAIL')) }}

{# Validate max mm/hr #}
{{ push('TEST: max_mm_per_hr == ' ~ expected.max_mm_per_hr ~ ' (got ' ~ max_mm_per_hr ~ ') â†’ ' ~ ((max_mm_per_hr == expected.max_mm_per_hr) and 'PASS' or 'FAIL')) }}

{# Validate rain_soon boolean #}
{{ push('TEST: rain_soon == ' ~ expected.rain_soon ~ ' (got ' ~ rain_soon ~ ') â†’ ' ~ ((rain_soon == expected.rain_soon) and 'PASS' or 'FAIL')) }}

{# Validate minutes until rain #}
{{ push('TEST: minutes_until_rain == ' ~ expected.minutes_until_rain ~ ' (got ' ~ minutes_until_rain ~ ') â†’ ' ~ ((minutes_until_rain == expected.minutes_until_rain) and 'PASS' or 'FAIL')) }}

{# Validate rain intensity #}
{{ push('TEST: rain_intensity == "' ~ expected.rain_intensity ~ '" (got "' ~ rain_intensity ~ '") â†’ ' ~ ((rain_intensity == expected.rain_intensity) and 'PASS' or 'FAIL')) }}

{# Validate expected rain duration (only actual rain minutes) #}
{{ push('TEST: expected_rain_duration == ' ~ expected.expected_rain_duration ~ ' (got ' ~ expected_rain_duration ~ ') â†’ ' ~ ((expected_rain_duration == expected.expected_rain_duration) and 'PASS' or 'FAIL')) }}

{# Validate compressed string length < 255 #}
{% set raw_ok = (raw_output | length) < 255 %}
{{ push('TEST: raw_output length < 255 chars (got ' ~ (raw_output | length) ~ ') â†’ ' ~ (raw_ok and 'PASS' or 'FAIL')) }}

{# Summary #}
{% set any_fail = (results.out | select('search','FAIL') | list | length) > 0 %}

=== TEST RESULTS FOR v1.6.2 ===
Rain threshold: {{ rain_threshold }} mm/h (NEW: was 0.05 mm/min = 3.0 mm/h)
Gap duration: {{ gap_duration }} minute(s)

Max precipitation: {{ max_mm_per_hr }} mm/h
Total rain in hour: {{ total_mm_next_hour }} mm

ğŸŒ§ï¸ Rain detected: {{ rain_soon }}
â° Minutes until rain: {{ minutes_until_rain }}
ğŸ’§ Rain intensity: {{ rain_intensity }}
â±ï¸ Expected rain duration: {{ expected_rain_duration }} minutes (actual rain only, not gaps)

=== RAW OUTPUT (smart compressed) ===
{{ raw_output }}
Length: {{ raw_output | length }} characters (must be < 255)

=== VALIDATION ===
{% for line in results.out %}
{{ line }}
{% endfor %}

Overall: {{ any_fail and 'âŒ FAIL' or 'âœ… PASS' }}

=== EXAMPLE: Light Rain Detection ===
Before (broken): 0.05 mm/min = 3.0 mm/h threshold
  â†’ Rain at 0.12, 0.16, 0.24 mm/h NOT DETECTED âŒ

After (fixed): 0.1 mm/h threshold
  â†’ Rain at 0.12, 0.16, 0.24 mm/h DETECTED âœ…

=== NOTES ===
- Rain detection now uses raw precipitation values (mm/h) directly
- Duration counts only actual rain minutes (11), not tolerated gaps
- With 1-minute gap tolerance: 3 rain + 1 gap + 8 rain = 11 rain minutes
- Smart compression reduces string length for 255-char limit
