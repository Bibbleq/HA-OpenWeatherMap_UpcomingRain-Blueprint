{# Full test with your actual data #}
{% set Minute_Weather = [
  {'datetime': '2025-10-31T14:17:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:18:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:19:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:20:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:21:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:22:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:23:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:24:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:25:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:26:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:27:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:28:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:29:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:30:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:31:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:32:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:33:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:34:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:35:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:36:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:37:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:38:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:39:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:40:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:41:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:42:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:43:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:44:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:45:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:46:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:47:00+00:00', 'precipitation': 0},
  {'datetime': '2025-10-31T14:48:00+00:00', 'precipitation': 0.12},
  {'datetime': '2025-10-31T14:49:00+00:00', 'precipitation': 0.16},
  {'datetime': '2025-10-31T14:50:00+00:00', 'precipitation': 0.2},
  {'datetime': '2025-10-31T14:51:00+00:00', 'precipitation': 0.52},
  {'datetime': '2025-10-31T14:52:00+00:00', 'precipitation': 0.83},
  {'datetime': '2025-10-31T14:53:00+00:00', 'precipitation': 1.15},
  {'datetime': '2025-10-31T14:54:00+00:00', 'precipitation': 1.46},
  {'datetime': '2025-10-31T14:55:00+00:00', 'precipitation': 1.78},
  {'datetime': '2025-10-31T14:56:00+00:00', 'precipitation': 1.55},
  {'datetime': '2025-10-31T14:57:00+00:00', 'precipitation': 1.32},
  {'datetime': '2025-10-31T14:58:00+00:00', 'precipitation': 1.1},
  {'datetime': '2025-10-31T14:59:00+00:00', 'precipitation': 0.87},
  {'datetime': '2025-10-31T15:00:00+00:00', 'precipitation': 0.65},
  {'datetime': '2025-10-31T15:01:00+00:00', 'precipitation': 1.25},
  {'datetime': '2025-10-31T15:02:00+00:00', 'precipitation': 1.85},
  {'datetime': '2025-10-31T15:03:00+00:00', 'precipitation': 2.45},
  {'datetime': '2025-10-31T15:04:00+00:00', 'precipitation': 3.05},
  {'datetime': '2025-10-31T15:05:00+00:00', 'precipitation': 3.65},
  {'datetime': '2025-10-31T15:06:00+00:00', 'precipitation': 2.94},
  {'datetime': '2025-10-31T15:07:00+00:00', 'precipitation': 2.23},
  {'datetime': '2025-10-31T15:08:00+00:00', 'precipitation': 1.53},
  {'datetime': '2025-10-31T15:09:00+00:00', 'precipitation': 0.82},
  {'datetime': '2025-10-31T15:10:00+00:00', 'precipitation': 0.12},
  {'datetime': '2025-10-31T15:11:00+00:00', 'precipitation': 0.13},
  {'datetime': '2025-10-31T15:12:00+00:00', 'precipitation': 0.15},
  {'datetime': '2025-10-31T15:13:00+00:00', 'precipitation': 0.17},
  {'datetime': '2025-10-31T15:14:00+00:00', 'precipitation': 0.19},
  {'datetime': '2025-10-31T15:15:00+00:00', 'precipitation': 0.2},
  {'datetime': '2025-10-31T15:16:00+00:00', 'precipitation': 0.16}
] %}

{% set rain_threshold = 0.05 %}
{% set minutes_list = Minute_Weather %}

{# Extract precipitation using map filter #}
{% set precip_vals = minutes_list | map(attribute='precipitation') | map('float') | list %}

{# Calculate values #}
{% set max_mm_per_min = (precip_vals | max) | float(0) %}
{% set max_mm_per_hr = (max_mm_per_min * 60) | round(1) %}
{% set total_mm_next_hour = (precip_vals | sum) | round(2) %}

{# Check for rain #}
{% set threshold = rain_threshold | float(0) %}
{% set above_threshold = precip_vals | select('>', threshold) | list %}
{% set rain_soon = above_threshold | length > 0 %}

{# Find first minute with rain (index) #}
{% set idx = namespace(value=precip_vals | length) %}
{% for i in range(precip_vals | length) %}
  {% if precip_vals[i] > threshold %}
    {% set idx.value = i %}
    {% break %}
  {% endif %}
{% endfor %}

{# minutes_until_rain should be the index (n) representing minutes until rain #}
{% if idx.value < (precip_vals | length) %}
  {% set minutes_until_rain = idx.value %}
  {% set first_val = precip_vals[idx.value] %}
{% else %}
  {# not found, use 60 as fallback (no rain within hour) #}
  {% set minutes_until_rain = 60 %}
  {% set first_val = 0 %}
{% endif %}

{# Determine intensity #}
{% set r = max_mm_per_hr %}
{% if not rain_soon or r < 0.1 %}
  {% set rain_intensity = "None" %}
{% elif r < 2.5 %}
  {% set rain_intensity = "Light" %}
{% elif r < 10 %}
  {% set rain_intensity = "Moderate" %}
{% elif r < 50 %}
  {% set rain_intensity = "Heavy" %}
{% else %}
  {% set rain_intensity = "Violent" %}
{% endif %}

{# ========== Validation Section (updated) ========== #}
{# Expected values derived from the test data above (minutes_until_rain uses index n) #}
{% set expected = {
  'data_points': 60,
  'rain_threshold': 0.05,
  'max_mm_per_min': 3.65,
  'max_mm_per_hr': 219.0,
  'total_mm_next_hour': 32.6,
  'rain_soon': true,
  'minutes_until_rain': 31,
  'rain_intensity': 'Violent',
  'first_rain_value': 0.12
} %}

{# Tolerances for float comparisons #}
{% set tol_min = 0.005 %}
{% set tol_hr = 0.1 %}
{% set tol_total = 0.01 %}
{% set tol_first = 0.005 %}

{% set results = namespace(out=[]) %}

{# Helper macro to push messages into results.out using namespace reassignment (safe) #}
{% macro push(msg) -%}
  {%- set results.out = results.out + [msg] -%}
{%- endmacro %}

{# Validate counts and thresholds #}
{{ push('TEST: data_points == ' ~ expected.data_points ~ ' â†’ ' ~ ( (precip_vals | length) == expected.data_points and 'PASS' or 'FAIL') ) }}
{{ push('TEST: rain_threshold == ' ~ expected.rain_threshold ~ ' â†’ ' ~ ( (threshold == expected.rain_threshold) and 'PASS' or 'FAIL') ) }}

{# Validate max mm/min (float) #}
{% set max_ok = ((max_mm_per_min - expected.max_mm_per_min) | abs) <= tol_min %}
{{ push('TEST: max_mm_per_min == ' ~ expected.max_mm_per_min ~ ' (got ' ~ max_mm_per_min ~ ') â†’ ' ~ (max_ok and 'PASS' or 'FAIL')) }}

{# Validate max mm/hr #}
{% set hr_ok = ((max_mm_per_hr - expected.max_mm_per_hr) | abs) <= tol_hr %}
{{ push('TEST: max_mm_per_hr == ' ~ expected.max_mm_per_hr ~ ' (got ' ~ max_mm_per_hr ~ ') â†’ ' ~ (hr_ok and 'PASS' or 'FAIL')) }}

{# Validate total mm #}
{% set total_ok = ((total_mm_next_hour - expected.total_mm_next_hour) | abs) <= tol_total %}
{{ push('TEST: total_mm_next_hour == ' ~ expected.total_mm_next_hour ~ ' (got ' ~ total_mm_next_hour ~ ') â†’ ' ~ (total_ok and 'PASS' or 'FAIL')) }}

{# Validate rain_soon boolean #}
{% set soon_ok = (rain_soon == expected.rain_soon) %}
{{ push('TEST: rain_soon == ' ~ expected.rain_soon ~ ' (got ' ~ rain_soon ~ ') â†’ ' ~ (soon_ok and 'PASS' or 'FAIL')) }}

{# Validate minutes until rain (index n) #}
{% set minutes_ok = (minutes_until_rain == expected.minutes_until_rain) %}
{{ push('TEST: minutes_until_rain == ' ~ expected.minutes_until_rain ~ ' (got ' ~ minutes_until_rain ~ ') â†’ ' ~ (minutes_ok and 'PASS' or 'FAIL')) }}

{# Validate rain intensity string #}
{% set intensity_ok = (rain_intensity == expected.rain_intensity) %}
{{ push('TEST: rain_intensity == "' ~ expected.rain_intensity ~ '" (got "' ~ rain_intensity ~ '") â†’ ' ~ (intensity_ok and 'PASS' or 'FAIL')) }}

{# Validate first rain value (float) using index #}
{% set first_ok = ((first_val - expected.first_rain_value) | abs) <= tol_first %}
{{ push('TEST: first_rain_value == ' ~ expected.first_rain_value ~ ' (got ' ~ first_val ~ ') â†’ ' ~ (first_ok and 'PASS' or 'FAIL')) }}

{# === RAW string output test (updated formatting rules) === #}
{# Build raw_output: two-decimal formatting, but:
     - if value == 0.00 -> "0"
     - if value is 0.something -> ".xx" (remove leading zero)
     - otherwise keep "N.nn" (including leading digit for >=1)
     no spaces, comma-separated #}
{% set ns_raw = namespace(out=[]) %}
{% for v in precip_vals %}
  {% set s = ('%.2f'|format(v)) %}
  {% if s == '0.00' %}
    {% set token = '0' %}
  {% elif s[:2] == '0.' %}
    {% set token = s[1:] %}
  {% else %}
    {% set token = s %}
  {% endif %}
  {% set ns_raw.out = ns_raw.out + [token] %}
{% endfor %}
{% set raw_output = ns_raw.out | join(',') %}

{# Expected raw string literal under the new formatting rules #}
{% set expected_raw = (
  '0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,' +
  '.12,.16,.20,.52,.83,1.15,1.46,1.78,1.55,1.32,1.10,.87,.65,1.25,1.85,2.45,3.05,3.65,2.94,2.23,1.53,.82,.12,.13,.15,.17,.19,.20,.16'
) %}

{% set raw_ok = (raw_output == expected_raw) %}
{{ push('TEST: raw_output == expected_raw â†’ ' ~ (raw_ok and 'PASS' or 'FAIL')) }}

{# Summary: any failures? #}
{% set any_fail = (results.out | select('search','FAIL') | list | length) > 0 %}

=== COMPLETE TEST RESULTS ===
Data points: {{ precip_vals | length }}
Rain threshold: {{ rain_threshold }} mm/min

Max precipitation: {{ max_mm_per_min }} mm/min ({{ max_mm_per_hr }} mm/hr)
Total rain in hour: {{ total_mm_next_hour }} mm

ğŸŒ§ï¸ Rain detected: {{ rain_soon }}
â° Minutes until rain (index n): {{ minutes_until_rain }}
ğŸ’§ Rain intensity: {{ rain_intensity }}

First rain (value at first index): {{ first_val }} mm/min

=== RAW OUTPUT (compact) ===
{{ raw_output }}

=== VALIDATION ===
{% for line in results.out %}
{{ line }}
{% endfor %}

Overall: {{ any_fail and 'FAIL' or 'PASS' }}
